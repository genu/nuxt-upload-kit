---
title: Cloudflare R2
description: Upload files to Cloudflare R2 with zero egress fees using presigned URLs.
navigation:
  icon: i-simple-icons-cloudflare
---

# Cloudflare R2

::prose-callout{type="warning" title="Experimental"}
This adapter is experimental and may change in future releases.
::

The `PluginCloudflareR2` adapter uploads files to Cloudflare R2 using presigned URLs. R2 is S3-compatible but offers **zero egress fees**, making it cost-effective for serving files.

## Installation

No client-side dependencies required! The adapter uses native `fetch` and `XMLHttpRequest`.

Your **backend** will need the AWS SDK (R2 is S3-compatible):

```bash [Terminal]
pnpm add @aws-sdk/client-s3 @aws-sdk/s3-request-presigner
```

## Usage

```ts
import { PluginCloudflareR2 } from "nuxt-upload-kit"

const uploader = useUploadKit({
  storage: PluginCloudflareR2({
    getPresignedUploadUrl: async (fileId, contentType, { fileName, fileSize }) => {
      const response = await fetch("/api/r2/presign", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ key: fileId, contentType, fileName, fileSize }),
      })
      return response.json()
    },
  }),
})
```

## Options

| Option                   | Type                                                    | Required | Description                              |
| ------------------------ | ------------------------------------------------------- | -------- | ---------------------------------------- |
| `getPresignedUploadUrl`  | `(fileId, contentType, metadata) => Promise<{...}>`     | Yes      | Function to fetch presigned upload URL   |
| `getPresignedDownloadUrl`| `(fileId) => Promise<string>`                           | No       | Function to fetch presigned download URL |
| `deleteFile`             | `(fileId) => Promise<void>`                             | No       | Function to delete a file via your API   |
| `retries`                | `number`                                                | No       | Number of retry attempts (default: 3)    |
| `retryDelay`             | `number`                                                | No       | Initial retry delay in ms (default: 1000)|

## Backend Setup

### R2 Credentials

1. Go to Cloudflare Dashboard → R2 → Manage R2 API Tokens
2. Create an API token with **Object Read & Write** permissions
3. Save the Access Key ID and Secret Access Key

### Generate Presigned Upload URL

```ts [server/api/r2/presign.post.ts]
import { S3Client, PutObjectCommand } from "@aws-sdk/client-s3"
import { getSignedUrl } from "@aws-sdk/s3-request-presigner"

const r2 = new S3Client({
  region: "auto",
  endpoint: `https://${process.env.CF_ACCOUNT_ID}.r2.cloudflarestorage.com`,
  credentials: {
    accessKeyId: process.env.R2_ACCESS_KEY_ID!,
    secretAccessKey: process.env.R2_SECRET_ACCESS_KEY!,
  },
})

const BUCKET = process.env.R2_BUCKET_NAME!
const PUBLIC_URL = process.env.R2_PUBLIC_URL! // e.g., https://pub-xxx.r2.dev or custom domain

export default defineEventHandler(async (event) => {
  const { key, contentType, fileName, fileSize } = await readBody(event)

  const objectKey = `uploads/${key}`

  const command = new PutObjectCommand({
    Bucket: BUCKET,
    Key: objectKey,
    ContentType: contentType,
    Metadata: {
      "original-name": fileName,
      "file-size": String(fileSize),
    },
  })

  const uploadUrl = await getSignedUrl(r2, command, { expiresIn: 3600 })

  return {
    uploadUrl,
    publicUrl: `${PUBLIC_URL}/${objectKey}`,
  }
})
```

### Delete File (Optional)

```ts [server/api/r2/delete/[key].delete.ts]
import { S3Client, DeleteObjectCommand } from "@aws-sdk/client-s3"

const r2 = new S3Client({ /* ... */ })

export default defineEventHandler(async (event) => {
  const key = getRouterParam(event, "key")

  await r2.send(new DeleteObjectCommand({
    Bucket: process.env.R2_BUCKET_NAME!,
    Key: `uploads/${key}`,
  }))

  return { success: true }
})
```

## Public Access

R2 offers two ways to serve files publicly:

### Option 1: R2.dev Subdomain

Enable public access in Cloudflare Dashboard → R2 → Your Bucket → Settings → Public Access.

You'll get a URL like: `https://pub-abc123.r2.dev`

### Option 2: Custom Domain

1. In R2 bucket settings, add a custom domain
2. Configure DNS to point to R2
3. Use your domain as the public URL

```ts
const PUBLIC_URL = "https://cdn.your-domain.com"
```

## Complete Example

```ts
import { PluginCloudflareR2 } from "nuxt-upload-kit"

const uploader = useUploadKit({
  storage: PluginCloudflareR2({
    getPresignedUploadUrl: async (fileId, contentType, metadata) => {
      const response = await fetch("/api/r2/presign", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ key: fileId, contentType, ...metadata }),
      })
      if (!response.ok) throw new Error("Failed to get upload URL")
      return response.json()
    },

    deleteFile: async (fileId) => {
      await fetch(`/api/r2/delete/${fileId}`, { method: "DELETE" })
    },

    retries: 3,
  }),
})
```

## Upload Result

After successful upload, `file.uploadResult` contains:

```ts
{
  url: 'https://pub-abc123.r2.dev/uploads/file-id.jpg',
  key: 'file-id.jpg',
  etag: 'd41d8cd98f00b204e9800998ecf8427e'
}
```

## CORS Configuration

Configure CORS for your R2 bucket in the Cloudflare Dashboard or via API:

```json
[
  {
    "AllowedOrigins": ["https://your-domain.com"],
    "AllowedMethods": ["PUT", "HEAD", "GET"],
    "AllowedHeaders": ["*"],
    "ExposeHeaders": ["ETag"],
    "MaxAgeSeconds": 3600
  }
]
```

## Environment Variables

```env [.env]
CF_ACCOUNT_ID=your-account-id
R2_ACCESS_KEY_ID=your-access-key-id
R2_SECRET_ACCESS_KEY=your-secret-access-key
R2_BUCKET_NAME=your-bucket-name
R2_PUBLIC_URL=https://pub-xxx.r2.dev
```

## Why R2?

| Feature          | R2                    | S3                    |
| ---------------- | --------------------- | --------------------- |
| Egress fees      | **$0**                | $0.09/GB              |
| Storage cost     | $0.015/GB/month       | $0.023/GB/month       |
| S3 compatibility | Yes                   | -                     |
| Global CDN       | Built-in              | Requires CloudFront   |

## Troubleshooting

### "403 Forbidden" on Upload

1. Check your presigned URL hasn't expired
2. Verify CORS is configured for your domain
3. Ensure the API token has write permissions

### Files Not Publicly Accessible

1. Enable public access on the bucket
2. Verify you're using the correct public URL (r2.dev subdomain or custom domain)

### "InvalidAccessKeyId"

Your R2 API token credentials are incorrect. Generate new credentials in Cloudflare Dashboard → R2 → Manage R2 API Tokens.
