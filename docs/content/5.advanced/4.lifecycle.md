---
title: File Lifecycle
description: Understanding the complete lifecycle of files in Nuxt Upload Kit.
navigation:
  icon: i-lucide-git-branch
---

# File Lifecycle

This guide explains the complete journey of a file from selection to upload completion.

## Lifecycle Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                         FILE SELECTION                          │
│                                                                 │
│  User selects file(s) via <input> or drag-and-drop             │
│                              ↓                                  │
│  uploader.addFiles([file1, file2, ...])                        │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                         1. VALIDATE                             │
│                                                                 │
│  • ValidatorMaxFiles - Check file count                         │
│  • ValidatorMaxFileSize - Check file size                       │
│  • ValidatorAllowedFileTypes - Check MIME type                  │
│  • Custom validators                                            │
│                                                                 │
│  ✗ Fail → file:error event, file.status = 'error'              │
│  ✓ Pass → Continue to preprocess                                │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                        2. PREPROCESS                            │
│                                                                 │
│  • PluginThumbnailGenerator - Generate preview                  │
│  • Custom preprocessors                                         │
│                                                                 │
│  Purpose: Immediate UI preparation                              │
│  file.preview is set here                                       │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                        FILE ADDED                               │
│                                                                 │
│  • File added to uploader.files                                 │
│  • file:added event emitted                                     │
│  • file.status = 'waiting'                                      │
│                                                                 │
│  If autoUpload: true → Continue to upload                      │
│  Otherwise: Wait for uploader.upload()                          │
└─────────────────────────────────────────────────────────────────┘
                               ↓
                    User calls uploader.upload()
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                         3. PROCESS                              │
│                                                                 │
│  • PluginImageCompressor - Compress images                      │
│  • PluginVideoCompressor - Compress videos                      │
│  • Custom processors                                            │
│                                                                 │
│  Purpose: Transform file before upload                          │
│  file.data may be modified here                                 │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                         4. UPLOAD                               │
│                                                                 │
│  • file.status = 'uploading'                                    │
│  • Storage plugin OR onUpload callback                          │
│  • upload:progress events                                       │
│                                                                 │
│  ✗ Fail → file:error event, file.status = 'error'              │
│  ✓ Pass → file.remoteUrl set, continue                         │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                        5. COMPLETE                              │
│                                                                 │
│  • file.status = 'complete'                                     │
│  • file.uploadResult set                                        │
│  • file.preview updated to remoteUrl (if no thumbnail)          │
│  • upload:complete event (after all files done)                 │
└─────────────────────────────────────────────────────────────────┘
```

## File States

A file goes through these statuses:

| Status           | Description                  |
| ---------------- | ---------------------------- |
| `waiting`        | File added, ready for upload |
| `preprocessing`  | Running preprocess hooks     |
| `uploading`      | Currently uploading          |
| `postprocessing` | Running complete hooks       |
| `complete`       | Successfully uploaded        |
| `error`          | Failed at any stage          |

## File Sources

Files can originate from different sources:

```ts
type FileSource = 'local' | 'storage' | 'instagram' | 'dropbox' | ...
```

| Source    | Description          | Has `data`      | Has `remoteUrl` |
| --------- | -------------------- | --------------- | --------------- |
| `local`   | Selected from device | Yes (File/Blob) | After upload    |
| `storage` | Loaded from storage  | No (null)       | Yes             |

## Local vs Remote Files

### Local Files

Created when user selects files:

```ts
const localFile: LocalUploadFile = {
  source: "local",
  data: File | Blob, // Has binary data
  remoteUrl: undefined, // Not uploaded yet
  status: "waiting",
}
```

After upload:

```ts
// data is still available
// remoteUrl is now set
// status is 'complete'
```

### Remote Files

Loaded from existing storage:

```ts
const remoteFile: RemoteUploadFile = {
  source: "storage",
  data: null, // No local data
  remoteUrl: "https://...", // Already uploaded
  status: "complete",
}
```

## Working with Both Types

Use the `source` property to handle files differently:

```ts
if (file.source === "local") {
  // TypeScript knows: file.data is File | Blob
  const blob = file.data
  const objectUrl = URL.createObjectURL(blob)
} else {
  // TypeScript knows: file.data is null, file.remoteUrl exists
  const url = file.remoteUrl
}
```

Or use the helper methods:

```ts
// Works for both local and remote
const url = await uploader.getFileURL(file.id)
const data = await uploader.getFileData(file.id) // Fetches remote if needed
```

## Replacing File Data

When you edit a file (crop, rotate), call `replaceFileData`:

```ts
const cropped = await cropImage(originalBlob)
await uploader.replaceFileData(file.id, cropped, "cropped-image.jpg")
```

This:

1. Updates `file.data` with new content
2. Changes `source` to `'local'` (even if it was remote)
3. Resets `status` to `'waiting'`
4. Clears `remoteUrl`
5. Re-runs preprocess hooks (regenerates thumbnail)
6. Emits `file:replaced` event

## Initializing Existing Files

Load files from your database:

```ts
// Provide file IDs
await uploader.initializeExistingFiles([{ id: "path/to/file1.jpg" }, { id: "path/to/file2.png", preview: "custom-preview-url" }])
```

The storage plugin's `getRemoteFile` hook fetches metadata:

```ts
// Storage plugin provides:
{
  size: number,
  mimeType: string,
  remoteUrl: string,
  preview?: string
}
```

## Memory Management

Nuxt Upload Kit automatically manages memory:

### Object URLs

- Created object URLs are tracked
- Automatically revoked when file is removed
- Cleaned up on component unmount

### Large Files

For large files (>100MB), prefer streaming:

```ts
// Loads into memory (avoid for large files)
const blob = await uploader.getFileData(file.id)

// More efficient - returns URL
const url = await uploader.getFileURL(file.id)

// Most efficient - streams data
const stream = await uploader.getFileStream(file.id)
```

## Event Timeline

Here's the complete event sequence:

```
addFiles([file])
    │
    ├─ (validation passes)
    │
    ├─ file:added ──────────── File visible in UI
    │
upload()
    │
    ├─ upload:start ────────── Upload begins
    │
    ├─ upload:progress ─────── Progress updates (0-100%)
    │   upload:progress
    │   upload:progress
    │   ...
    │
    ├─ upload:complete ─────── All files done
    │
    └─ (check file.uploadResult for results)
```

Error events can occur at any point:

```
addFiles([invalid])
    │
    └─ file:error ──────────── Validation failed

upload()
    │
    ├─ upload:start
    │
    └─ file:error ──────────── Upload failed
```

## Debugging Lifecycle

Enable verbose logging:

```ts
if (import.meta.dev) {
  const events = [
    "file:added",
    "file:removed",
    "file:replaced",
    "file:error",
    "upload:start",
    "upload:progress",
    "upload:complete",
    "image-compressor:start",
    "image-compressor:complete",
  ]

  events.forEach((event) => {
    uploader.on(event, (data) => {
      console.log(`[Upload] ${event}:`, data)
    })
  })
}
```
